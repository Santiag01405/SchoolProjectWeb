@model List<SchoolProjectWeb.Models.User>

@{
    ViewData["Title"] = "Lista de Usuarios";
}

<h2 class="main-title text-center mb-4">Usuarios Registrados</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}


<!-- Barra de búsqueda -->
<div class="row mb-3">
    <div class="col-md-6">
        <label for="searchInput" class="form-label fw-bold">Buscar por nombre:</label>
        <input type="text" id="searchInput" class="form-control" placeholder="Ingrese nombre del usuario..." />
    </div>
    <div class="col-md-4">
        <label for="roleFilter" class="form-label fw-bold">Filtrar por rol:</label>
        <select id="roleFilter" class="form-select">
            <option value="all">Todos</option>
            <option value="1">Alumnos</option>
            <option value="2">Profesores</option>
            <option value="3">Padres</option>
        </select>
    </div>
</div>

<!-- Función para mostrar el nombre del rol -->
@functions {
    string GetRoleName(int roleId)
    {
        return roleId switch
        {
            1 => "Alumno",
            2 => "Profesor",
            3 => "Padre",
            _ => "Desconocido"
        };
    }
}

@if (!Model.Any())
{
    <p class="text-muted">No hay usuarios registrados.</p>
}
else
{
    <div class="table-responsive card-zoom5">
        <table class="table table-striped table-bordered align-middle" id="usersTable">
            <thead style="background-color: #0C4251; color: white;">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr class="user-row" data-role="@user.RoleID" data-name="@user.UserName.ToLower()">
                        <td>@user.UserID</td>
                        <td>@user.UserName</td>
                        <td>@user.Email</td>
                        <td>@GetRoleName(user.RoleID)</td>
                        <td>
                            <div class="d-flex flex-wrap gap-2">
                                <a class="btn btn-sm btn-yellow me-1" asp-action="EditUser" asp-route-id="@user.UserID">Editar</a>

                                @if (user.RoleID == 2)
                                {
                                    <a class="btn btn-lightblue me-1" asp-action="ViewTaughtCourses" asp-route-userId="@user.UserID">Ver cursos</a>
                                }

                                <form asp-action="DeleteUser" asp-route-id="@user.UserID" method="post"
                                      onsubmit="return confirm('¿Estás seguro de que deseas eliminar este usuario?');" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        const roleFilter = document.getElementById("roleFilter");
        const searchInput = document.getElementById("searchInput");

        function applyFilters() {
            const selectedRole = roleFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            const rows = document.querySelectorAll(".user-row");

            let visibleIndex = 0;

            rows.forEach(row => {
                const role = row.getAttribute("data-role");
                const name = row.getAttribute("data-name");

                const roleMatch = (selectedRole === "all" || role === selectedRole);
                const nameMatch = name.includes(searchTerm);

                if (roleMatch && nameMatch) {
                    row.style.display = "";
                    row.classList.remove("table-light");
                    if (visibleIndex % 2 === 0) {
                        row.classList.add("table-light");
                    }
                    visibleIndex++;
                } else {
                    row.style.display = "none";
                    row.classList.remove("table-light");
                }
            });
        }

        roleFilter.addEventListener("change", applyFilters);
        searchInput.addEventListener("input", applyFilters);
    </script>
}
